<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chess 2023 | Multiplayer</title>
    <link rel="stylesheet" href="./Styles/style.css" />
    <link rel="stylesheet" href="./Styles/common.css" />
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"
      integrity="sha512-luMnTJZ7oEchNDZAtQhgjomP1eZefnl82ruTH/3Oj/Yu5qYtwL7+dVRccACS/Snp1lFXq188XFipHKYE75IaQQ=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    ></script>
    <style></style>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script src="./ChessJS/chess.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js.map"></script>
    <script src="./Assets/chessboard/js/chessboard-1.0.0.js"></script>
    <link
      rel="stylesheet"
      href="./Assets/chessboard/css/chessboard-1.0.0.css"
    />
  </head>

  <body>
    <span id="tp" class="fw-bold">Total Players :- 0</span>
    <div id="gameSetup" class="container d-flex gap-4 mt-5">
      <div id="board1" style="width: 500px"></div>
      <div id="matchTimerSelector" class="d-flex flex-column">
        <p class="fs-1">Playing Match Of:-</p>
        <div class="row align-items-start justify-content-start">
          <div class="col">
            <button onclick="match_request(10)" class="btn btn-primary btn-lg">
              10 Minutes
            </button>
          </div>
          <div class="col">
            <button onclick="match_request(15)" class="btn btn-primary btn-lg">
              15 Minutes
            </button>
          </div>
          <div class="col">
            <button onclick="match_request(20)" class="btn btn-primary btn-lg">
              20 Minutes
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="move_history"></div>
    <p class="d-none" id="wait_para">Waiting for opponent</p>
    <script>
      let cPlayer;
      var board = null;
      var game = new Chess();
      var whiteSquareGrey = "#a9a9a9";
      var blackSquareGrey = "#696969";

      function removeGreySquares() {
        $("#board1 .square-55d63").css("background", "");
      }

      function greySquare(square) {
        var $square = $("#board1 .square-" + square);

        var background = whiteSquareGrey;
        if ($square.hasClass("black-3c85d")) {
          background = blackSquareGrey;
        }

        $square.css("background", background);
      }

      function onDragStart(source, piece) {
        if (game.turn() != cPlayer) {
          return false;
        }

        // do not pick up pieces if the game is over
        if (game.game_over()) return false;

        // or if it's not that side's turn
        if (
          (game.turn() === "w" && piece.search(/^b/) !== -1) ||
          (game.turn() === "b" && piece.search(/^w/) !== -1)
        ) {
          return false;
        }
      }

      function onDrop(source, target) {
        if (game.turn() != cPlayer) {
          return false;
        }

        removeGreySquares();

        // see if the move is legal
        var move = game.move({
          from: source,
          to: target,
          promotion: "q", // NOTE: always promote to a queen for example simplicity
        });

        // illegal move
        if (move === null) return "snapback";
        socket.emit("SNYC_MOVE", game.fen(), game.turn());
      }

      function onMouseoverSquare(square, piece) {
        if (game.turn() != cPlayer) {
          return false;
        }

        // get list of possible moves for this square
        var moves = game.moves({
          square: square,
          verbose: true,
        });

        // exit if there are no moves available for this square
        if (moves.length === 0) return;

        // highlight the square they moused over
        greySquare(square);

        // highlight the possible squares for this piece
        for (var i = 0; i < moves.length; i++) {
          greySquare(moves[i].to);
        }
      }

      function onMouseoutSquare(square, piece) {
        if (game.turn() != cPlayer) {
          return false;
        }

        removeGreySquares();
      }

      function onSnapEnd() {
        if (game.turn() != cPlayer) {
          return false;
        }

        board.position(game.fen());
      }

      var config = {
        draggable: true,
        position: "start",
        onDragStart: onDragStart,
        onDrop: onDrop,
        onMouseoutSquare: onMouseoutSquare,
        onMouseoverSquare: onMouseoverSquare,
        onSnapEnd: onSnapEnd,
      };
      board = Chessboard("board1", config);
    </script>

    <script>
      function initializeGame(orientation) {
        board = Chessboard("board1", config);
        board.orientation(orientation);
      }

      let currentMatchTime = 0;
      function match_request(duration) {
        const gameSetupElement = document.getElementById("gameSetup");
        currentMatchTime = duration;
        const wait_para_element = document.getElementById("wait_para");
        gameSetupElement.classList.add("d-none");
        wait_para_element.classList.remove("d-none");
        socket.emit("MATCH_REQUEST", duration);
      }

      function updateTotalPlayers(tpInt) {
        const totalPlayerEl = document.getElementById("tp");
        if (totalPlayerEl) {
          totalPlayerEl.innerHTML = "Total Players :- " + tpInt;
        }
      }

      const socket = io("http://localhost:3000", {
        autoConnect: true,
      });

      socket.on("MATCH_START", function (player) {
        cPlayer = player;
        initializeGame(player === "w" ? "white" : "black");
        const gameSetupElement = document.getElementById("gameSetup");
        const wait_para_element = document.getElementById("wait_para");
        const matchTimerSelectorElement =
          document.getElementById("matchTimerSelector");
        gameSetupElement.classList.remove("d-none");
        wait_para_element.classList.add("d-none");
        const youareplayingas =
          "You are playing as " + (player == "w" ? "White" : "Black");
        matchTimerSelectorElement.innerHTML =
          '<p class="fs-4">' +
          youareplayingas +
          '</p><p id="timer" class="fs-1">' +
          currentMatchTime +
          ":00</p>";
        if(player != 'w')
        {
          startTimer(true);
        }
      });

      let no = 2;
      socket.on("SNYC_MOVE", function (state, turn) {
        game.setTurn(turn);
        if (turn != cPlayer) {
          stopTimer();
        } else {
          startTimer();
        }
        game.load(state);
        board.position(state);
      });

      let totalSeconds = currentMatchTime * 60;
      let interval;

      const startTimer = function (fromZero) {
        if (fromZero) {
          totalSeconds = currentMatchTime * 60;
          clearInterval(interval);
        }
        const timerElement = document.getElementById("timer");
        interval = setInterval(function () {
          const minutes = Math.floor(totalSeconds / 60);
          let seconds = totalSeconds % 60;

          const formattedTime = `${minutes
            .toString()
            .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

          timerElement.innerHTML = formattedTime;

          if (totalSeconds === 0) {
            clearInterval(interval);
          } else {
            totalSeconds--;
          }
        }, 1000);
      };

      const stopTimer = function () {
        clearInterval(interval);
      };

      socket.on("UPDATE_TOTAL_PLAYER", (totalPlayersInt) => {
        updateTotalPlayers(totalPlayersInt);
      });
    </script>
  </body>
</html>
